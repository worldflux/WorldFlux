name: Parity Official

on:
  pull_request:
    paths:
      - "scripts/parity/**"
      - "tests/test_scripts/test_*parity*"
      - "tests/test_scripts/test_aws_distributed_orchestrator.py"
      - ".github/workflows/parity-official.yml"
  workflow_dispatch:
    inputs:
      wf_region:
        description: AWS region
        required: true
        default: us-west-2
      wf_instance_ids:
        description: SSM managed EC2 instance IDs (comma-separated)
        required: true
        default: i-04b017c35ee53a11a
      wf_s3_bucket:
        description: S3 bucket for parity artifacts
        required: true
        default: worldflux-parity
      worldflux_sha:
        description: WorldFlux commit SHA (blank uses workflow SHA)
        required: false
        default: ""
      max_retries:
        description: Max retries per task/system run
        required: true
        default: "2"
  schedule:
    - cron: "0 9 * * 1"

jobs:
  parity-smoke:
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Run parity smoke tests
        run: |
          uv run pytest -q \
            tests/test_scripts/test_end_to_end_parity_smoke.py \
            tests/test_scripts/test_run_parity_matrix_sharding.py \
            tests/test_scripts/test_parity_completeness_gate.py \
            tests/test_scripts/test_stats_equivalence.py \
            tests/test_scripts/test_suite_contract_schema_v2.py \
            tests/test_scripts/test_metric_transforms_effect_size.py \
            tests/test_scripts/test_family_plugin_registry.py \
            tests/test_scripts/test_validity_gate_rejects_random_policy_in_proof_mode.py

  parity-full-distributed:
    if: ${{ github.event_name != 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: uv sync --extra dev

      - name: Resolve AWS authentication mode
        id: auth
        shell: bash
        env:
          AWS_ROLE_TO_ASSUME: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          set -euo pipefail
          if [ -n "${AWS_ROLE_TO_ASSUME:-}" ]; then
            echo "mode=oidc" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          if [ -n "${AWS_ACCESS_KEY_ID:-}" ] && [ -n "${AWS_SECRET_ACCESS_KEY:-}" ]; then
            echo "mode=keys" >> "${GITHUB_OUTPUT}"
            exit 0
          fi

          echo "mode=none" >> "${GITHUB_OUTPUT}"
          echo "::warning::Skipping parity-official full run: AWS credentials are not configured."

      - name: Configure AWS credentials (OIDC role)
        if: ${{ steps.auth.outputs.mode == 'oidc' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ github.event.inputs.wf_region || 'us-west-2' }}

      - name: Configure AWS credentials (access keys)
        if: ${{ steps.auth.outputs.mode == 'keys' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.wf_region || 'us-west-2' }}

      - name: Run distributed parity orchestration
        if: ${{ steps.auth.outputs.mode != 'none' }}
        shell: bash
        run: |
          set -euo pipefail

          WF_REGION="${{ github.event.inputs.wf_region }}"
          WF_INSTANCE_IDS="${{ github.event.inputs.wf_instance_ids }}"
          WF_S3_BUCKET="${{ github.event.inputs.wf_s3_bucket }}"
          WF_SHA="${{ github.event.inputs.worldflux_sha }}"
          MAX_RETRIES="${{ github.event.inputs.max_retries }}"

          if [ -z "${WF_REGION}" ]; then WF_REGION="us-west-2"; fi
          if [ -z "${WF_INSTANCE_IDS}" ]; then WF_INSTANCE_IDS="i-04b017c35ee53a11a"; fi
          if [ -z "${WF_S3_BUCKET}" ]; then WF_S3_BUCKET="worldflux-parity"; fi
          if [ -z "${MAX_RETRIES}" ]; then MAX_RETRIES="2"; fi

          RUN_ID="parity_full_$(date -u +%Y%m%dT%H%M%SZ)"
          S3_PREFIX="s3://${WF_S3_BUCKET}/${RUN_ID}"

          EXTRA_ARGS=()
          if [ -n "${WF_SHA}" ]; then
            EXTRA_ARGS+=(--worldflux-sha "${WF_SHA}")
          fi

          uv run python scripts/parity/aws_distributed_orchestrator.py \
            --region "${WF_REGION}" \
            --instance-ids "${WF_INSTANCE_IDS}" \
            --manifest scripts/parity/manifests/official_vs_worldflux_full_v1.yaml \
            --run-id "${RUN_ID}" \
            --s3-prefix "${S3_PREFIX}" \
            --device cuda \
            --max-retries "${MAX_RETRIES}" \
            "${EXTRA_ARGS[@]}"

      - name: Upload orchestrator summary
        if: ${{ steps.auth.outputs.mode != 'none' }}
        uses: actions/upload-artifact@v4
        with:
          name: parity-orchestrator-summary
          path: reports/parity/**/orchestrator_summary.json
          if-no-files-found: ignore
