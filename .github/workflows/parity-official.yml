name: Parity Official

on:
  workflow_dispatch:
    inputs:
      wf_region:
        description: AWS region
        required: true
        default: us-west-2
      wf_instance_id:
        description: SSM managed EC2 instance id
        required: true
        default: i-04b017c35ee53a11a
      worldflux_sha:
        description: WorldFlux commit SHA (blank uses current workflow SHA)
        required: false
        default: ""
  schedule:
    - cron: "0 9 * * 1"

jobs:
  parity-official:
    if: ${{ secrets.AWS_ROLE_TO_ASSUME != '' || (secrets.AWS_ACCESS_KEY_ID != '' && secrets.AWS_SECRET_ACCESS_KEY != '') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC role)
        if: ${{ secrets.AWS_ROLE_TO_ASSUME != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ github.event.inputs.wf_region || 'us-west-2' }}

      - name: Configure AWS credentials (access keys)
        if: ${{ secrets.AWS_ROLE_TO_ASSUME == '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ github.event.inputs.wf_region || 'us-west-2' }}

      - name: Submit parity command via SSM
        id: submit
        shell: bash
        run: |
          set -euo pipefail

          REGION="${{ github.event.inputs.wf_region }}"
          INSTANCE_ID="${{ github.event.inputs.wf_instance_id }}"
          WF_SHA="${{ github.event.inputs.worldflux_sha }}"
          if [ -z "${REGION}" ]; then REGION="us-west-2"; fi
          if [ -z "${INSTANCE_ID}" ]; then INSTANCE_ID="i-04b017c35ee53a11a"; fi
          if [ -z "${WF_SHA}" ]; then WF_SHA="${GITHUB_SHA}"; fi

          RUN_ID="parity_$(date -u +%Y%m%dT%H%M%SZ)"
          export RUN_ID WF_SHA

          COMMANDS_JSON="$(python3 - <<'PY'
          import json
          import os

          run_id = os.environ["RUN_ID"]
          wf_sha = os.environ["WF_SHA"]
          commands = [
              "set -eu",
              f"mkdir -p /opt/parity/{run_id} && cd /opt/parity/{run_id}",
              "git clone https://github.com/worldflux/WorldFlux.git worldflux",
              "git clone https://github.com/danijar/dreamerv3.git dreamerv3-official",
              "git clone https://github.com/nicklashansen/tdmpc2.git tdmpc2-official",
              f"cd worldflux && git checkout {wf_sha}",
              "cd ../dreamerv3-official && git checkout b65cf81a6fb13625af8722127459283f899a35d9",
              "cd ../tdmpc2-official && git checkout 8bbc14ebabdb32ea7ada5c801dc525d0dc73bafe",
              "cd ../worldflux",
              f"python3 scripts/parity/run_parity_matrix.py --manifest scripts/parity/manifests/official_vs_worldflux_v1.yaml --run-id {run_id} --device cuda",
              f"python3 scripts/parity/stats_equivalence.py --input reports/parity/{run_id}/parity_runs.jsonl --output reports/parity/{run_id}/equivalence_report.json",
              f"python3 scripts/parity/report_markdown.py --input reports/parity/{run_id}/equivalence_report.json --output reports/parity/{run_id}/equivalence_report.md",
              f"cat reports/parity/{run_id}/equivalence_report.json",
          ]
          print(json.dumps(commands))
          PY
          )"

          COMMAND_ID="$(aws ssm send-command \
            --region "${REGION}" \
            --instance-ids "${INSTANCE_ID}" \
            --document-name AWS-RunShellScript \
            --timeout-seconds 172800 \
            --parameters "commands=${COMMANDS_JSON}" \
            --query 'Command.CommandId' \
            --output text)"

          echo "run_id=${RUN_ID}" >> "${GITHUB_OUTPUT}"
          echo "region=${REGION}" >> "${GITHUB_OUTPUT}"
          echo "instance_id=${INSTANCE_ID}" >> "${GITHUB_OUTPUT}"
          echo "command_id=${COMMAND_ID}" >> "${GITHUB_OUTPUT}"

      - name: Print follow-up commands
        run: |
          echo "Run ID: ${{ steps.submit.outputs.run_id }}"
          echo "Command ID: ${{ steps.submit.outputs.command_id }}"
          echo "aws ssm list-command-invocations --region ${{ steps.submit.outputs.region }} --command-id ${{ steps.submit.outputs.command_id }} --details"
          echo "aws ssm get-command-invocation --region ${{ steps.submit.outputs.region }} --command-id ${{ steps.submit.outputs.command_id }} --instance-id ${{ steps.submit.outputs.instance_id }} --query StandardOutputContent --output text"
