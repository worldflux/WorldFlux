name: Release

on:
  release:
    types: [published]

jobs:
  verify:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405
        with:
          python-version: "3.11"

      - name: Set up uv
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86
        with:
          enable-cache: true
          cache-dependency-glob: pyproject.toml

      - name: Install dependencies
        run: uv sync --extra dev --extra docs

      - name: Validate docs domain TLS and HTTPS
        run: |
          uv run python scripts/check_docs_domain_tls.py \
            --host worldflux.ai \
            --url https://worldflux.ai/ \
            --expected-san worldflux.ai

      - name: Validate release metadata
        run: uv run python scripts/check_release_metadata.py --tag "${{ github.event.release.tag_name }}"

      - name: Validate release checklist gate wiring
        run: uv run python scripts/check_release_checklist_gate.py

      - name: Run public contract freeze + parity tests
        run: uv run pytest -q tests/test_public_contract_freeze.py tests/test_parity/

      - name: Validate fixed parity artifacts (release gate)
        run: |
          uv run python scripts/validate_parity_artifacts.py \
            --run reports/parity/runs/dreamer_atari100k.json \
            --run reports/parity/runs/tdmpc2_dmcontrol39.json \
            --aggregate reports/parity/aggregate.json \
            --lock reports/parity/upstream_lock.json \
            --required-suite dreamer_atari100k \
            --required-suite tdmpc2_dmcontrol39 \
            --max-missing-pairs 0

      - name: Validate parity suite policy coverage
        run: |
          uv run python scripts/check_parity_suite_coverage.py \
            --policy reports/parity/suite_policy.json \
            --lock reports/parity/upstream_lock.json \
            --aggregate reports/parity/aggregate.json \
            --enforce-pass

      - name: Build docs (strict)
        run: uv run mkdocs build --strict

      - name: Run security checks
        run: |
          uv run --with bandit bandit -r src/worldflux/ -ll
          uv run --with pip-audit pip-audit

      - name: Generate verification report artifact
        run: |
          uv run python scripts/generate_verification_report.py \
            --check release_metadata=pass \
            --check release_checklist_gate=pass \
            --check docs_domain_tls=pass \
            --check public_contract_freeze=pass \
            --check parity_harness_tests=pass \
            --check parity_release_gate=pass \
            --check parity_suite_policy=pass \
            --check docs_strict=pass \
            --check security_bandit=pass \
            --check security_pip_audit=pass \
            --parity-aggregate reports/parity/aggregate.json \
            --upstream-lock reports/parity/upstream_lock.json \
            --output-json reports/release/verification-report.json \
            --output-md reports/release/verification-report.md

      - name: Upload verification report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: verification-report
          path: reports/release/

  build:
    needs: verify
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405
        with:
          python-version: "3.11"

      - name: Set up uv
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86
        with:
          enable-cache: true
          cache-dependency-glob: pyproject.toml

      - name: Build package
        run: uv run --with build python -m build

      - name: Check package
        run: uv run --with twine twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02
        with:
          name: dist
          path: dist/

  publish-pypi:
    needs: build
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e

  publish-testpypi:
    needs: build
    runs-on: ubuntu-latest
    environment: testpypi
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          name: dist
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e
        with:
          repository-url: https://test.pypi.org/legacy/
